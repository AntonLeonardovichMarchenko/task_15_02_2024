<!-- Mars Mission -->

<!DOCTYPE html>
<html lang="en">
<head>


    <title>bootstrapTest_1</title>

    <p>
    <!-- ссылка на начальную страницу -->
    <a href = 'First_go.html'> Go to First_go page </a>
</p>
<p>
    <a href = 'http://google.com'> go to Google </a>
</p>


  <!-- meta теги -->
  <meta charset="utf-8">
  <!-- это обеспечивает правильный рендеринг и позиционирование) -->
 <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ширину страницы в соответствии с шириной
       экрана устройства (которая будет варьироваться
       в зависимости от устройства)
                        устанавливает начальный уровень масштабирования
                        при первой загрузке страницы браузером

     -->
<!--
    подключение bootstrap.
-->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.css" rel="stylesheet">

  <style>
  /* CSS-код помогает bootstrap */

.btnSend{
  bottom: 450px;
  left: 535px;
}

.lRow{
  font: italic 15pt sans-serif;
  color: rgb(49,79, 80);
  font-weight: lighter;

  /*
  position: fixed;
  text-align: center;
  bottom: 450px;
  left: 235px;
  */
}

    .zRow{
        margin-top: 25px;
        margin-bottom: 15px;
    }

  </style>

</head>

<!--
Формат заявки (формы) на участие в миссии 'MM' состоит из шести полей. В форме собирается
следующая информация :

= Имя (для приглашения на собеседование или безусловный отказ).
= Пол (M & F) поровну (как-никак на Марс летим и надолго).
= Возраст (лучше молодые).
= Почта (для переписки).
= Специальность — различные инженеры и учёные для основной работы, врачи, психологи...

-->

<body>


<form id="mars-mission" method="post" action="localhost:3000/">

<div class="container">

    <div class="col col-4 row" >
        <h1>Страница оформления заявки MARS Mission.</h1>
    </div>

    <label class="lRow">Просьба со всей ответственностью отнестись к заполнению анкеты.</label>

    <div class="col col-4 zRow" >
        <label>
        Имя:
            <input name="name" type="text" id="idName" placeholder="     " autofocus>
        </label>
    </div>

    <div class="zRow col-5">
            <label>
                sex:
                <select name="sex" required>
                <option value="M" selected>М</option>
                <option value="F">Ж</option>
                <option value="other">...</option>
                </select>
            </label>

    </div>

    <div class="col-5 zRow">
        <label>
            Возраст:
            <input type="number" name="age" required>
        </label>
    </div>

    <div class="col-5 zRow" >

        <label for="email" class="form-label">Email:
        <input type="email" name = "mail" id="email" class="form-control"  placeholder="name@example.com">
        </label>

    </div>

    <div class="col-5 zRow">
        <label>
            Род занятий:  <!-- именно РОД ЗАНЯТИЙ! Там твой диплом никому не нужен -->
                <select name="occupation" required>
                    <option value="engineering" selected>Инженерия</option>
                    <option value="science">Наука</option>
                    <option value="medicine">Медицина</option>
                    <option value="psychology">Психология</option>
                    <option value="other">Другое</option>
                </select>
        </label>
    </div>

    <div class="col-5 zRow" > <!--name="motivation"> -->
        <label for="exampleFormControlTextarea1" class="form-label">мотивация (зачем Вам это)</label>
        <textarea name="motivation" class="form-control" id="exampleFormControlTextarea1" rows="2"></textarea>
    </div>


    <div class="zRow">

        <!-- При нажатии на кнопку "btn btn-secondary" (bootstrap) происходят:
        = генерация события onclick на форме, которое связывается с обработчиком события
        = и вызовом функции handleFormSubmit()
        -->
         <button class="btn btn-secondary" onclick="handleFormSubmit" > Send Data </button>

    </div>

</div>
</form>


<script>

/* Объект, в который записывается информация, полученная из полей формы.
   Это (пока!) глобальная структура. Может быть, когда-нибудь получится
   упрятать это безобразие. Хотя форма (ссылка на объект) вроде тоже глобальная!
   И ничего... */

let _data = {
   name: '',
   sex: '',
   age: '',
   mail: '',
   occupation: '',
   motivation: '',
};


// После создания формы в HTML можно обратится к объекту form для получения с помощью JavaScript
// введенных в форму данных.
// Форма состоит из полей: name, sex, age, email, occupation, motivation и одной кнопки submit.
// Надо найти все поля формы, получить значения полей и записать их (в объект data).
// В дальнейшем этот объект будет передаваться на сервер.

// =======================================================================
// Найти объект form по идентификатору с помощью метода document.getElementById.
// и подписаться на событие submit
const form = document.getElementById('mars-mission');

// =======================================================================
// Назначение функции обработки события обеспечивается функцией addEventListener.
// При вызове addEventListener первым параметром передаётся отслеживаемое событие
// submit (клик по кнопке), вторым параметром - название callback-функции
// (функции-обработчика), которая обеспечивает реакцию на событие.
// При отправке формы сработает событие submit, и срабатывает "слушатель" события
// - callback-функция handleFormSubmit. Она вызывается после клика по кнопке.
// И отслеживает это событие и реагирует на него соответствующими действиями.
// ВАЖНО! Эта функция позволяет отслеживать клики по РАЗНЫМ кнопкам формы!
// В качестве аргумента callback-функция handleFormSubmit получает ссылку на событие
// событие 'submit' - это тоже ОБЪЕКТ.
// handleFormSubmit должна отсканировать поля формы и извлечь из них соответствующие значения.

form.addEventListener('submit', handleFormSubmit);
//                    слушается событие отправки 'submit'
//                            назначается функция обработки события handleFormSubmit


// В объекте события submit форма хранится в свойстве target. Функция handleFromSubmit()
// стала асинхронной, так как она вызывает другую асинхронную функцию и дожидается её
// результата. Внутри response будет поле status, по которому можно будет определить,
// успешно ли прошёл запрос и вывести соответствующее сообщение.

// После нажатия на кнопку Отправить и при выполнении функции handleFormSubmit,
// браузер по умолчанию перезапускается (проверено!).
// И после перезапуска выполнение приложения аварийно завершается с кодом 404 (not found).
// Перезапуск браузера блокируется методом preventDefault, который вызывается в функции
// обработки события handleFormSubmit от имени события, представленного параметром event.

// Таким образом:
// = нажимается кнопка,
// = "срабатывает" и обрабатывается событие 'submit',
// = вызывается функция обработки события,
// = блокируется перезапуск браузера,
// = вызывается функция сбора информации с полей формы,
// = собранная информация передаётся на сервер.

async function handleFormSubmit(event) {
   event.preventDefault();  //блокировка перезапуска формы

// serializeForm - варианты сбора информации с полей формы
// у формы есть свойство elements, которое содержит в себе все элементы управления
// и поля формы. Именно этим свойством надо воспользоваться, чтобы получить все данные из формы.
// Если вызвать эту функцию, передав туда форму form как параметр, то в консоли появится
// список всех элементов с соответствующими значениями:
// поле name
// поле sex
// поле age
// поле mail
// поле occupation
// поле motivation

// тип этого набора элементов — HTMLFormControlsCollection.
// Чтобы пройтись по списку элементов циклом, нужно преобразовать
// его в массив с помощью вызова Array.from().


  serializeForm(event.target);
  const response = await sendData();
  log_console(event);
}

// Варианты сбора информации с полей формы
// _______________________________________________________________________

// первый вариант сборщика информации с полей формы - он заблокирован.
// И в чём его кривизна?
// Получен список элементов, который был преобразован в массив и просмотрен.
//     У каждого элемента получены поля name и value, которые были выведены в консоль.
//     В консоли после запуска получим вывод по каждому из полей:

// 1 {name: 'name', value: 'XXXXXXX'}
// 2 {name: 'sex', value: 'M' }
// 3 {name: 'age', value: '24'}
// 4 {name: 'mail', value: 'some@mail.com'}
// 4 {name: 'occupation', value: 'engineer'}
// 5 {name: 'motivation', value: 'хочу на марс'}
// 6 {name: '', value: ''}

// Последняя строчка не имеет ни названия, ни значения. Это потому,
// что последний элемент, который здесь проверялся — это кнопка.

function serializeForm_OLD(formKey){
    const { elements } = formKey;
    Array.from(elements).forEach(   // ЭТО МЕТОД !!!
                                    (element) => {
                                                    const { name, value } = element
                                                    console.log({ name, value })
                                                  }
                                 );
}
// _______________________________________________________________________
/*
ВТОРОЙ вариант сборщика информации с полей формы:
Пустые элементы без названия можно выкинуть из набора с помощью метода filter.
Также можно заменить метод forEach на map — он собирает массив, который хранит
объект с именем и значением каждого отфильтрованного элемента.
*/
function serializeForm(formKey){

    const { elements } = formKey;

    // здесь можно обойтись без переменной data. Просто всё начать грузить сразу в _data

    // 1. Логический оператор НЕ (!) (логическое отрицание) меняет логическое значение операнда
    //    с истины в ложь и наоборот. Обычно он используется с булевыми (логическими) значениями.
    //    При использовании с любыми другими значениями, если операнд может быть преобразован в true,
    //    то вернёт false; в противном случае он возвращается true.
    // 2. Т.е. ! возвращает false, если операнд МОЖЕТ БЫТЬ преобразован в true; в противном
    //    случае возвращается true.
    // 3. Если значение может быть преобразовано в true, то оно рассматривается как ИСТИННОПОДОБНОЕ
    //    (truthy). Если же значение может быть преобразовано в false, то оно называется
    //    ЛОЖНОПОДОБНЫМ (falsy).
    // 4. Примеры ЛОЖНОПОДОБНЫХ выражений, которые могут быть преобразованы в false:
    //      null;
    //      NaN;
    //      0;
    //      пустая строка ("", '', ``);
    //      undefined.
    //  5. Чтобы явным образом принудительно преобразовать любое значение в соответствующий
    //     булевый примитив можно один за другим использовать пару операторов (!!).
    //     Преобразование основано на "истинноподобности" или "ложноподобности" значения
    //     truthy и falsy. Точно такое же преобразование может быть выполнено с помощью
    // функции Boolean (en-US).


    // собрать в массив data инфу из формы
    //                             отфильтровать её
    //                                 задать структуру элементов массива в виде пары {имя, значение}
    let data = Array.from(elements)
                                    .filter((item) => !!item.name)
                                                                   .map((element) => {
                                                                                const { name, value } = element
                                                                                return { name, value }
                                                                                      }
                                                                        );

    _data = data; // ссылка на локальный массив data присваивается глобальной переменной _data

    console.log('>>>>> 0 >>>>>', _data);
    console.log(_data[0].value, // name
                _data[1].value, // sex
                _data[2].value, // age
                _data[3].value, // mail
                _data[4].value, // occupation
                _data[5].value, // motivation
                );

}

// =======================================================================
// Собранные из формы данные надо отправить на сервер. Функция отправки работает
// с сетевыми запросами, потому она асинхронная.
// Запрос НА СЕРВЕР отправляется асинхронной функцией fetch.
// Список аргументов функции:
// = адрес сервера (в любом виде!)
// = структура с полями method
//                      headers
//                      body

// функция sendData отправляет функцией fetch серверу данные из формы, с которыми
// на сервере можно что-либо сделать. Но это уже серверные заморочки.

// Функцию sendData можно непосредственно применить в обработчике события отправки.
// Данные извлекаются из формы функцией serializeForm и передаются в функцию
// отправки sendData. Вместо непосредственного обращения к форме, она "извлекается" из
// объекта события.

// асинхронные заморочки:
// = Promise (объект «промис») – это специальный объект в JavaScript,
// который связывает вместе «создающий» и «потребляющий» коды (КЛИЕНТА и СЕРВЕРА).
// Это «список для подписки». «Создающий» код может выполняться сколько потребуется,
// чтобы получить результат, а промис делает результат доступным для кода, который подписан на него,
// когда результат готов.
// = примочка await работает только внутри async–функций.
// await заставляет интерпретатор JavaScript ждать до тех пор, пока промис
// справа от await не выполнится. После чего await вернёт результат промиса и
// выполнение кода продолжится.

async function sendData() { // ### 1 #####################################

//                    метод отправки данных на сервер method - POST
//                    заголовок запроса для формы Content-Type - multipart/form-data
//                    данные  body - _data

// ================= server_0.js - тот самый сервер!
console.log('>>>>> 1 >>>>>',_data);

return await fetch('/server_0.js',
                                    {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'multipart/form-data' },
                                      body: _data,  // собранные в форме данные (массив значений)
                                    }
                    );

} // ### 1 ###############################################################

fetch("/server_0.js")
    .then(response => {
        console.log(response.status);       // 200
        console.log(response.statusText);   // OK
        console.log(response.url);          // localhost:3000/bootstrapTest_1.html



    });


function log_console(event){
console.log("Mars Mission!", event);
}

</script>


</body>
</html>